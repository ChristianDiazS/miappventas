// Prisma schema file
// Documentation: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== USERS ==============
model User {
  id            Int             @id @default(autoincrement())
  email         String          @unique
  passwordHash  String
  firstName     String
  lastName      String
  phone         String
  role          Role            @default(CUSTOMER)
  active        Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  // Relations
  addresses     Address[]
  orders        Order[]
  payments      Payment[]
  reviews       Review[]
  auditLogs     AuditLog[]
  
  @@index([email])
  @@index([role])
}

// ============== ADDRESSES ==============
model Address {
  id            Int             @id @default(autoincrement())
  userId        Int
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  label         String?
  street        String
  city          String
  district      String?
  province      String?
  department    String?
  postalCode    String?
  lat           Float?
  lng           Float?
  isDefault     Boolean         @default(false)
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  // Relations
  orders        Order[]
  
  @@index([userId])
}

// ============== CATEGORIES ==============
model Category {
  id            Int             @id @default(autoincrement())
  name          String          @unique
  slug          String          @unique
  description   String?
  image         String?         // URL de imagen/banner
  active        Boolean         @default(true)
  
  // Estructura jerárquica (opcional)
  parentId      Int?            // null = categoría principal
  parent        Category?       @relation("ParentChild", fields: [parentId], references: [id], onDelete: SetNull)
  children      Category[]      @relation("ParentChild")
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @default(now()) @updatedAt
  
  // Relations
  products      Product[]
  
  @@index([slug])
  @@index([parentId])
}

// ============== PRODUCTS ==============
model Product {
  id            Int             @id @default(autoincrement())
  sku           String          @unique
  title         String
  description   String          @db.Text
  price         Int             // en centavos (39900 = S/. 399.00)
  originalPrice Int?
  
  categoryId    Int
  category      Category        @relation(fields: [categoryId], references: [id])
  
  stock         Int             @default(0)
  weight        Float?
  active        Boolean         @default(true)
  rating        Float           @default(0)
  reviewCount   Int             @default(0)
  
  // Campos para productos combinados
  type          String          @default("individual")  // "individual" o "combo"
  comboItems    Json?           // { collar: true, dije: true, arete: false, anillo: false }
  
  // Campos para variantes (tallas, colores, etc)
  image         String?         // imagen principal
  sizes         Json?           // ["S", "M", "L", "XL"]
  selectedSize  String?         // talla seleccionada por defecto
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  // Relations
  images        ProductImage[]
  features      ProductFeature[]
  orderItems    OrderItem[]
  inventory     InventoryItem[]
  reviews       Review[]
  
  @@index([categoryId])
  @@index([sku])
}

// ============== PRODUCT IMAGES ==============
model ProductImage {
  id            Int             @id @default(autoincrement())
  productId     Int
  product       Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  url           String
  alt           String?
  isPrimary     Boolean         @default(false)
  order         Int             @default(0)
  createdAt     DateTime        @default(now())
  
  @@index([productId])
}

// ============== PRODUCT FEATURES ==============
model ProductFeature {
  id            Int             @id @default(autoincrement())
  productId     Int
  product       Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  feature       String
  
  @@index([productId])
}

// ============== REVIEWS ==============
model Review {
  id            Int             @id @default(autoincrement())
  productId     Int
  product       Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  userId        Int
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  rating        Int             // 1-5
  title         String?
  content       String          @db.Text
  helpful       Int             @default(0)
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  @@index([productId])
  @@index([userId])
  @@unique([productId, userId]) // Un review por usuario por producto
}

// ============== ORDERS ==============
model Order {
  id            Int             @id @default(autoincrement())
  orderNumber   String          @unique
  userId        Int
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  items         OrderItem[]
  
  shippingAddressId Int?
  shippingAddress   Address?    @relation(fields: [shippingAddressId], references: [id])
  
  shippingMethod  ShippingMethod @default(STANDARD)
  deliverySlot    String?
  
  subtotal      Int             // en centavos
  tax           Int             // en centavos
  shippingCost  Int             // en centavos
  total         Int             // en centavos
  
  status        OrderStatus     @default(PENDING)
  paymentStatus PaymentStatus   @default(PENDING)
  notes         String?
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  // Relations
  payments      Payment[]
  auditLogs     AuditLog[]
  shipment      Shipment?
  
  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
}

// ============== ORDER ITEMS ==============
model OrderItem {
  id            Int             @id @default(autoincrement())
  orderId       Int
  order         Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId     Int
  product       Product         @relation(fields: [productId], references: [id])
  
  quantity      Int
  unitPrice     Int             // Precio en centavos al momento de compra
  subtotal      Int             // quantity * unitPrice
  
  createdAt     DateTime        @default(now())
  
  @@index([orderId])
  @@index([productId])
}

// ============== PAYMENTS ==============
model Payment {
  id            Int             @id @default(autoincrement())
  orderId       Int
  order         Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  userId        Int
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  provider      String          // "stripe", "mercadopago"
  providerId    String          // ID de transacción en el provider
  amount        Int             // en centavos
  
  status        PaymentStatus   @default(PENDING)
  metadata      Json?           // Información adicional del proveedor
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  @@index([orderId])
  @@index([userId])
  @@index([status])
}

// ============== INVENTORY ==============
model InventoryItem {
  id            Int             @id @default(autoincrement())
  warehouseId   Int
  warehouse     Warehouse       @relation(fields: [warehouseId], references: [id])
  
  productId     Int
  product       Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  quantity      Int
  updatedAt     DateTime        @updatedAt
  
  @@unique([warehouseId, productId])
  @@index([warehouseId])
  @@index([productId])
}

// ============== WAREHOUSES ==============
model Warehouse {
  id            Int             @id @default(autoincrement())
  name          String          @unique
  location      String
  latitude      Float?
  longitude     Float?
  active        Boolean         @default(true)
  createdAt     DateTime        @default(now())
  
  // Relations
  inventory     InventoryItem[]
  
  @@index([active])
}

// ============== DRIVERS ==============
model Driver {
  id            Int             @id @default(autoincrement())
  name          String
  phone         String
  vehicle       String?
  status        DriverStatus    @default(AVAILABLE)
  currentLat    Float?
  currentLng    Float?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  @@index([status])
}

// ============== AUDIT LOGS ==============
model AuditLog {
  id            Int             @id @default(autoincrement())
  userId        Int
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  orderId       Int?
  order         Order?          @relation(fields: [orderId], references: [id], onDelete: SetNull)
  
  action        String          // "order_created", "payment_completed", etc
  entity        String          // "order", "product"
  entityId      Int
  
  previousData  Json?
  newData       Json?
  
  createdAt     DateTime        @default(now())
  
  @@index([userId])
  @@index([createdAt])
  @@index([action])
}

// ============== ENUMS ==============
enum Role {
  CUSTOMER
  ADMIN
  SUPERADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum ShippingMethod {
  STANDARD
  EXPRESS
  PICKUP
}

enum DriverStatus {
  AVAILABLE
  BUSY
  OFFLINE
}

// ============== SHIPPING ==============
model ShippingZone {
  id            Int             @id @default(autoincrement())
  name          String          @unique // "Costa", "Sierra", "Selva", etc
  departments   String[]        // ["Lima", "Callao", "Ica", etc]
  description   String?
  active        Boolean         @default(true)
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  // Relations
  shippingRates ShippingRate[]
  
  @@index([name])
}

model ShippingRate {
  id            Int             @id @default(autoincrement())
  zoneId        Int
  zone          ShippingZone    @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  
  method        ShippingMethod  // STANDARD, EXPRESS, PICKUP
  baseCost      Int             // en centavos
  costPerKg     Int             // costo adicional por kg
  estimatedDays Int             // días estimados de entrega
  maxWeight     Float?          // peso máximo permitido
  
  active        Boolean         @default(true)
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  // Relations
  shipments     Shipment[]
  
  @@unique([zoneId, method])
  @@index([zoneId])
}

model Shipment {
  id            Int             @id @default(autoincrement())
  orderId       Int             @unique
  order         Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  shippingRateId Int
  shippingRate  ShippingRate    @relation(fields: [shippingRateId], references: [id])
  
  department    String          // Destino: "Lima", "Junín", etc
  address       String          // Dirección completa
  totalWeight   Float           // peso total en kg
  shippingCost  Int             // en centavos
  
  trackingNumber String?
  carrierName   String?         // Empresa de envío (Olva, IFEP, etc)
  
  status        String          @default("pending") // pending, shipped, delivered, failed
  shippedAt     DateTime?
  deliveredAt   DateTime?
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  @@index([orderId])
  @@index([status])
}

